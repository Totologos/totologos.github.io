<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Réservation de créneaux</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="container">
  <h2>Réservation des créneaux</h2>

  <!-- Message d’attente -->
  <div id="loading-message">Chargement des créneaux...</div>

  <!-- Contenu caché pendant le chargement -->
  <form id="reservation-form" style="display:none;">
    <table id="reservation-table">
      <thead>
        <tr>
          <th>Stand</th>
          <th>1ère partie</th>
          <th>Entracte</th>
          <th>2e partie</th>
        </tr>
      </thead>
      <tbody id="table-body">
        <!-- Rempli dynamiquement -->
      </tbody>
    </table>
    <div id="user-info">
      <input type="text" name="nom" placeholder="Nom" required>
      <input type="text" name="prenom" placeholder="Prénom" required>
      <input type="email" name="email" placeholder="Email" required>
      <button type="submit">Réserver</button>
    </div>
  </form>
</div>

  <script>
    confidential = true; // true si on veut cacher les noms des réservations
    const scriptUrl = "https://script.google.com/macros/s/AKfycbxER5nolQcpLtEF7Kb728MRkssbt6r72FYDWJP6QXynqZdP_ls-R-79OkZcCksq69BJ/exec"; // Remplace par ton URL

    const loadingMessage = document.getElementById("loading-message");
    const reservationForm = document.getElementById("reservation-form");

    const lastCheckedByGroup = {};

    // Affiche le message de chargement, cache le formulaire
    loadingMessage.style.display = "block";
    reservationForm.style.display = "none";

    fetch(scriptUrl)
      .then(res => res.json())
      .then(data => {
        buildTable(data);
        // Une fois les données prêtes, cacher le message et afficher le formulaire
        loadingMessage.style.display = "none";
        reservationForm.style.display = "block";
      })
      .catch(error => {
        loadingMessage.textContent = "Erreur de chargement des données.";
        console.error("Erreur lors du chargement :", error);
      });

    function buildTable(data) {
      const tableBody = document.getElementById("table-body");

      const grouped = {};
      data.forEach(item => {
        if (!grouped[item.stand]) grouped[item.stand] = {};
        if (!grouped[item.stand][item.partie]) grouped[item.stand][item.partie] = [];
        grouped[item.stand][item.partie].push(item);
      });

      Object.keys(grouped).forEach(stand => {
        const tr = document.createElement("tr");

        const standCell = document.createElement("td");
        standCell.textContent = stand;
        standCell.classList.add("stand-cell");
        tr.appendChild(standCell);

        ["1ère partie", "Entracte", "2ieme partie"].forEach(partie => {
          const td = document.createElement("td");
          //td.classList.add("slot-cell");

          const slots = grouped[stand][partie] || [];
          firstEmpty = true
          slots.forEach(slot => {
            const div = document.createElement("div");
            div.classList.add("sub-slot");
            div.classList.add(slot.nom ? "taken" : "available");

            if (slot.nom) {
              if(confidential) {
                div.textContent = `Réservé`;
              } else {
                div.textContent = `${slot.prenom} ${slot.nom}`;
              }
            } else {
              
              if(firstEmpty) {
                firstEmpty = false;
                const radio = document.createElement("input");
                radio.type = "radio";
                radio.name = `selectedSlot ${partie}`;
                radio.value = JSON.stringify({
                  stand: slot.stand,
                  partie: slot.partie,
                  numero: slot.numero
                });
                // gestion du clic sur le radio permettant de décocher
                // le dernier radio coché du même groupe
                radio.addEventListener('click', function() {
                  const groupName = this.name;
                  if (lastCheckedByGroup[groupName] === this) {
                    this.checked = false;
                    lastCheckedByGroup[groupName] = null;
                  } else {
                    lastCheckedByGroup[groupName] = this;
                  }
              });
                div.appendChild(radio);
              }
              else
              {
                div.textContent = `Libre`;
              }
            }

            td.appendChild(div);
          });

          tr.appendChild(td);
        });

        tableBody.appendChild(tr);
      });
    }
    
    document.getElementById("reservation-form").addEventListener("submit", function (e) {
      e.preventDefault();

      const form = e.target;

      const nom = form.nom.value.trim();
      const prenom = form.prenom.value.trim();
      const email = form.email.value.trim();

      if (!nom || !prenom || !email) {
        alert("Merci de remplir tous les champs.");
        return;
      }

      const selectedRadio = form.querySelector("input[type='radio']:checked");
      if (!selectedRadio) {
        alert("Merci de sélectionner un créneau.");
        return;
      }

      const selectedSlot = selectedRadio.value;

      const payload = {
        nom,
        prenom,
        email,
        selectedSlot
      };

      fetch(scriptUrl, {
        method: "POST",
        body: JSON.stringify(payload),
        headers: {
          "Content-Type": "application/json"
        }
      })
        .then(response => response.json())
        .then(result => {
          if (result.success) {
            alert("Réservation enregistrée !");
            // Optionnel : recharger les créneaux
            location.reload();
          } else {
            alert("Erreur : " + result.message);
          }
        })
        .catch(error => {
          console.error("Erreur :", error);
          alert("Erreur lors de l'envoi des données.");
        });
    });

  </script>
</body>
</html>